---
title: "evaluate methods on second generation simulation: cyclic trajectory"
author: "Koen Van den Berge"
date: "6 February 2019"
output: html_document
---

```{r data}
library(slingshot)
library(RColorBrewer)
library(mgcv)
library(tradeR)
library(edgeR)
library(rafalib)
library(wesanderson)

data=readRDS("~/Dropbox/PhD/Research/singleCell/trajectoryInference/trajectoryDE/tradeRPaper/simulation/sim2_dyngen_cycle/80.rds")
counts <- t(data$counts)
falseGenes <- data$feature_info$gene_id[!data$feature_info$housekeeping]
nullGenes <- data$feature_info$gene_id[data$feature_info$housekeeping]

## the housekeeping genes are too obvious null.
# we will generate more realistic null genes by permuting cells of false genes.
set.seed(9)
permNull1 <- t(apply(counts[falseGenes,],1,sample))
dimnames(permNull1) <- list(paste0("pn",1:length(falseGenes)),paste0("C",1:558))
permNull2 <- t(apply(counts[falseGenes,],1,sample))
dimnames(permNull2) <- list(paste0("pn",(length(falseGenes)+1):(2*length(falseGenes))),paste0("C",1:558))
permNull3 <- t(apply(counts[falseGenes,],1,sample))
dimnames(permNull3) <- list(paste0("pn",(2*length(falseGenes)+1):(3*length(falseGenes))),paste0("C",1:558))
counts <- rbind(counts,permNull1,permNull2,permNull3)

pal <- wes_palette("Zissou1", 12, type = "continuous")
truePseudotime <- data$prior_information$timecourse_continuous
g <- Hmisc::cut2(truePseudotime,g=12)

# quantile normalization
FQnorm <- function(counts){
  rk <- apply(counts,2,rank,ties.method='min')
  counts.sort <- apply(counts,2,sort)
  refdist <- apply(counts.sort,1,median)
  norm <- apply(rk,2,function(r){ refdist[r] })
  rownames(norm) <- rownames(counts)
  return(norm)
}
normCounts <- FQnorm(counts)

## dim red
pca <- prcomp(log1p(t(normCounts)), scale. = FALSE)
rd <- pca$x[,1:2]
plot(rd, pch=16, asp = 1, col=pal[g])

library(princurve)
pcc <- principal_curve(rd, smoother="periodic_lowess")
lines(x=pcc$s[order(pcc$lambda),1], y=pcc$s[order(pcc$lambda),2], col="red", lwd=2)
```

# fit smoothers on raw data

```{r}
cWeights <- rep(1,ncol(counts))
pseudoT <- matrix(pcc$lambda,nrow=ncol(counts),ncol=1)
gamList <- fitGAM(counts, pseudotime=pseudoT, cellWeights=cWeights, verbose=TRUE)
```

# Test for association of expression with the trajectory

```{r}
assocTestRes <- associationTest(gamList)
hist(assocTestRes$pvalue)
```

# tradeR on true pseudotime

```{r}
### tradeR on true pseudotime
pst <- matrix(truePseudotime, nrow=ncol(counts), ncol=1, byrow=FALSE)
gamListTrueTime <- fitGAM(counts, pseudotime=pst, cellWeights=cWeights, verbose=TRUE)
assocTestTrueRes <- associationTest(gamListTrueTime)
hist(assocTestTrueRes$pvalue)
```

# plot false genes

```{r}
pdf("~/Dropbox/PhD/Research/singleCell/trajectoryInference/trajectoryDE/tradeRPaper/simulation/sim2_dyngen_cycle/falseGenesTruePseudotime.pdf")
for(i in 1:length(falseGenes)){
   plotSmoothers(gamListTrueTime[[falseGenes[i]]])
}
dev.off()
```

# plot null genes

```{r}
pdf("~/Dropbox/PhD/Research/singleCell/trajectoryInference/trajectoryDE/tradeRPaper/simulation/sim2_dyngen_cycle/nullGenesTruePseudotime.pdf")
for(i in 1:length(nullGenes)){
   plotSmoothers(gamListTrueTime[[nullGenes[i]]])
}
dev.off()
```

# plot permuted null genes

```{r}
pnGenes <- rownames(counts)[substr(rownames(counts),1,2)=="pn"]
pdf("~/Dropbox/PhD/Research/singleCell/trajectoryInference/trajectoryDE/tradeRPaper/simulation/sim2_dyngen_cycle/permutedNullGenesTruePseudotime.pdf")
for(i in 1:length(pnGenes)){
   plotSmoothers(gamListTrueTime[[pnGenes[i]]])
}
dev.off()
```

# plot example genes

```{r}
mypar(mfrow=c(1,3))
i=1
plotSmoothers(gamListTrueTime[[falseGenes[i]]], main="false gene")
plotSmoothers(gamListTrueTime[[nullGenes[i]]], main="null gene")
plotSmoothers(gamListTrueTime[[pnGenes[i]]], main="permuted null gene")
```

# Performance plots

```{r}
########
# FDP-TPR
########
library(iCOBRA)
library(scales)
truth <- as.data.frame(matrix(rep(0,nrow(counts)), dimnames=list(rownames(counts),"status")))
truth[falseGenes,"status"] <- 1

### estimated pseudotime
pval <- data.frame( tradeR_slingshot_assoc=assocTestRes$pval,
                      row.names=rownames(counts))
cobra <- COBRAData(pval=pval, truth=truth)
cobra <- calculate_adjp(cobra)
cobra <- calculate_performance(cobra, binary_truth="status")
cobraplot <- prepare_data_for_plot(cobra)
plot_roc(cobraplot)
plot_fdrtprcurve(cobraplot, pointsize=3/2, yaxisrange=c(0.8,1))
```
